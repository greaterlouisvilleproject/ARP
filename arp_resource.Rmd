---
title: "arp_resource"
output: html_document
date: "2022-11-17"
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, 
                      dev.args=list(bg="transparent"), fig.width=16,fig.height=12)
library(glptools)
glp_load_packages(TRUE)
library(arrow)
library(viridis)
library(forcats)
library(hrbrthemes)
library(glpdata)
```


```{r peer_citie}
FIPS_df <- glptools::FIPS_df

FIPS_info <- glptools::FIPS_info
```


```{r governments}
# Create clean governments data frame
projects <- read_csv("ARP Project Reports - Projects.csv",
                      col_types = "cccccccccccncnncnnccc")

## Read in city and county allocations
city_allocations <- read_csv("fiscalrecoveryfunds-metrocitiesfunding1-CSV.csv")
county_allocations <- read_csv("fiscalrecoveryfunds_countyfunding_2021.05.10-1a.csv")

# Select only government ID columns, keep only distinct rows, and replace the Birmingham FIPS code 1073 with 01073
governments <- projects %>%
  select(FIPS, 
         State, 
         city_county = `city/county`, 
         city_county_status = `city/county_status`) %>%
  distinct() %>%
  pull_peers()

# Should have 17 cities and 17 - 3 = 14 counties 

FIPS_population <- FIPS_info %>%
  filter(
    county != "St. Louis County", 
    FIPS != "MERGED", 
    current == 1)

# Read in city population data
city_pop <- read_csv("city_pop.csv")

FIPS_population %<>% 
  left_join(city_pop, by = "city") %>%
  select(FIPS, city, state, county, city_population = population)

# Read in county population and combine with city population
county_pop <- glpdata::population_county %>%
  filter(year == max(year),
         sex == "total",
         race == "total") %>%
  select(FIPS, county_population = population)

FIPS_population %<>%
  left_join(county_pop, by = "FIPS")

FIPS_population %<>%
  mutate(
    city = case_when(
      city == "Jacksonville" ~ "Jacksonville city",
      city == "Louisville" ~ "Louisville-Jefferson County",
      city == "St. Louis" ~ "St Louis",
      city == "Nashville" ~ "Nashville-Davidson",
      TRUE ~ city),
    county = case_when(
      county == "St. Louis City" ~ "St. Louis city", 
       county == "St. Louis County" ~ "St. Louis", 
      county == "Richmond City" ~ "Richmond city", 
      TRUE ~ county))

city_allocations %<>%
  inner_join(FIPS_population, by = c("State" = "state", "City" = "city")) %>%
  transmute(
    FIPS, 
    city_county_status = "city",
    allocation = Allocation) 

county_allocations %<>%
  mutate(
    County = str_remove_all(County, " County")) %>%
  inner_join(FIPS_population, by = c("State" = "state", "County" = "county")) %>%
  transmute(
    FIPS,
    city_county_status = "county",
    allocation = Allocation)

all_allocations <- bind_rows(city_allocations, county_allocations)

all_allocations %<>%
  mutate(allocation = str_remove(allocation, "\\$") %>% 
           str_remove_all(",") %>%
           as.numeric()) 

city_allocations <- all_allocations %>%
  filter(city_county_status == "city") %>%
  rename(city_allocation = allocation) %>%
  select(-city_county_status)

county_allocations <- all_allocations %>%
  filter(city_county_status == "county") %>%
  rename(county_allocation = allocation) %>%
  select(-city_county_status)

governments_wide <- FIPS_population %<>%
  left_join(city_allocations) %>%
  left_join(county_allocations) %>%
  select(FIPS, city_allocation, county_allocation, city_population, county_population) %>%
  mutate(total_allocation = city_allocation + county_allocation)

# Replace St. Louis FIPS since we have now added city and county data in the same row

governments_wide$FIPS[governments_wide$FIPS == "29510"] <- "MERGED"

all_allocations %<>%
  mutate(
    city_county_status = if_else(FIPS %in% c(18097, 21111, 47037), "merged", city_county_status)) %>%
  group_by(FIPS, city_county_status) %>%
  summarize(allocation = sum(allocation), .groups = "drop")


governments_long <- governments %>%
  left_join(all_allocations, by = c("FIPS", "city_county_status"))


rm(FIPS_population, governments, city_allocations, county_allocations, city_pop, county_pop, all_allocations)
```


```{r projects}
projects %<>%
  mutate(FIPS = if_else(FIPS == "1073", "01073", FIPS))


```

```{r louisville expenditures}
expenditures_lou <- read_csv("ARP Project Reports - Expenditures.csv",
                             col_types = "cccnnnnn")

```

```{r peer expenditure cleanup}

#create crosswalk file
expenditures_peer_crosswalk <- read_csv("ARP Project Reports - project_to_govenment_crosswalk.csv") %>%
  mutate(
    `Recipient Name`= `Recipeint Name`
  )


#read in quarterly expenditures
q4_2021_peer_exp <- read_csv("SLFRF-January-2022-Quarterly-Data-through-December-31-2021.xlsx - Project Updated.csv")
q1_2022_peer_exp <- read.csv("April-2022-Quarterly-and-Annual-Reporting-Data-through-March-31-2022 (5).xlsx - Projects.csv")
q2_2022_peer_exp <-read.csv("July-2022-Quarterly-Reporting-Data-through-June-30-2022 (5).xlsx - Projects.csv")


####### recode column names

#q2 2022
q2_2022_peer_exp_filter <- q2_2022_peer_exp %>% 
  select('Recipient.Name', 'State.Territory', 'Completion.Status', "Project.Name", "Expenditure.Category.Group",
         "Expenditure.Category", "Project.Description", "Adopted.Budget", "Total.Cumulative.Obligations", "Total.Cumulative.Expenditures"
) %>% 
  mutate_at(c("Adopted.Budget", 
              "Total.Cumulative.Obligations", 
              "Total.Cumulative.Expenditures"), ~as.numeric(str_remove_all(., ","))) %>%
  mutate(year = '2022',
         quarter = 'Q2')

#q1 2022
#does not contain 'Completion.Status'
q1_2022_peer_exp_filter <- q1_2022_peer_exp %>%
  select('Recipient.Name', 'State.Territory', "Project.Name", "Expenditure.Category.Group", "Expenditure.Category", "Project.Description", "Adopted.Budget", "Total.Cumulative.Obligations", "Total.Cumulative.Expenditures"
  ) %>%
  mutate_at(c("Adopted.Budget", 
              "Total.Cumulative.Obligations", 
              "Total.Cumulative.Expenditures"), ~as.numeric(str_remove_all(., ","))) %>%
    mutate(year = '2022',
         quarter = 'Q1')

#q4 2021
#does not have completion status
q4_2021_peer_exp_filter <- q4_2021_peer_exp %>%
  select("Recipient Name", "State/Territory", "Project Name", "Expenditure Category Group", 
         "Expenditure Category", "Project Description", "Adopted Budget", "Total Obligations", "Total Expenditures"
  ) %>%
  mutate(
    Recipient.Name = `Recipient Name`,
    State.Territory = `State/Territory`,
    Project.Name = `Project Name`,
    Expenditure.Category.Group = `Expenditure Category Group`,
    Expenditure.Category = `Expenditure Category`,
    Project.Description = `Project Description`,
    Adopted.Budget = `Adopted Budget`,
    Total.Cumulative.Obligations = `Total Obligations`,
    Total.Cumulative.Expenditures = `Total Expenditures`
    ) %>%
  select("Recipient.Name", "State.Territory", "Project.Name", "Expenditure.Category.Group", 
         "Expenditure.Category", "Project.Description", "Adopted.Budget", "Total.Cumulative.Obligations", "Total.Cumulative.Expenditures") %>%
    mutate(year = '2021',
         quarter = 'Q4')

#bind rows
expenditures_peer_temp <- bind_rows(q2_2022_peer_exp_filter, 
                                    q1_2022_peer_exp_filter, 
                                    q4_2021_peer_exp_filter)


#create new column in expenditures_peer_temp with state abbreviation
expenditures_peer_temp$state_abbr <- state.abb[match(expenditures_peer_temp$State.Territory, state.name)]


#merge expenditures_peer_temp with cross walk
expenditures_peer_temp <- expenditures_peer_temp %>%
  mutate(
    `Recipient Name`= Recipient.Name
  )

expenditures_crosswalk_merge <- expenditures_peer_crosswalk %>%
  left_join(expenditures_peer_temp, by = c("Recipient Name", "state_abbr"))

#merge expenditures_crosswalk_merge with government dataframe
expenditure_peer <- governments_long %>%
  left_join(expenditures_crosswalk_merge, by = c("city_county", "city_county_status")) %>% 
  mutate(State = State.x) %>%
  select(-c("Recipeint Name", "State.y", "state_abbr", "Recipient Name", "State.Territory", "State.x")) %>%
  relocate(State, .before = city_county)

expenditures <- expenditure_peer

rm(q4_2021_peer_exp, q4_2021_peer_exp_filter,
   q1_2022_peer_exp, q1_2022_peer_exp_filter,
   q2_2022_peer_exp, q2_2022_peer_exp_filter,
   expenditures_crosswalk_merge, expenditures_peer_temp,
   expenditures_peer_crosswalk, expenditure_peer)
  
```

```{r}
load("app/data_export.RData")

```

```{r}
save(FIPS_df, FIPS_info, governments_long, governments_wide, projects, expenditures, expenditures_lou, usa, counties, file = "app/data_export2.RData")

```

