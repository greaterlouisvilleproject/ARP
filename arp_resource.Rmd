---
title: "arp_resource"
output: html_document
date: "2022-11-17"
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, 
                      dev.args=list(bg="transparent"), fig.width=16,fig.height=12)
library(glptools)
glp_load_packages(TRUE)
library(arrow)
library(viridis)
library(forcats)
library(hrbrthemes)
library(glpdata)
```


```{r peer_citie}
FIPS_df <- glptools::FIPS_df

FIPS_info <- glptools::FIPS_info
```


```{r governments}
# Create clean governments data frame
projects <- read_csv("ARP Project Reports - Projects.csv",
                      col_types = "cccccccccccncnncnnccc")

# Select only government ID columns, keep only distinct rows, and replace the Birmingham FIPS code 1073 with 01073
governments <- projects %>%
  select(FIPS, 
         State, 
         city_county = `city/county`, 
         city_county_status = `city/county_status`) %>%
  distinct() %>%
  pull_peers()

# Should have 17 cities and 17 - 3 = 14 counties 


## Read in city and county allocations
cities <- read_csv("fiscalrecoveryfunds-metrocitiesfunding1-CSV.csv")
counties <- read_csv("fiscalrecoveryfunds_countyfunding_2021.05.10-1a.csv")

# Create a FIPS data frame with 
FIPS_info_subset <- FIPS_info %>%
  filter(
    county != "St. Louis County", 
    FIPS != "MERGED", 
    current == 1)

# Read in city population data
city_pop <- read_csv("city_pop.csv") %>% 
  left_join(FIPS_info_subset) %>%
  select(FIPS, city_population = population)

# Read in county population and combine with city population
pop_df <- glpdata::population_county %>%
  filter(year == max(year),
         sex == "total",
         race == "total") %>%
  select(FIPS, county_population = population) %>%
  left_join(city_pop)

FIPS_info_subset <- FIPS_info %>%
  mutate(
    city = case_when(
      city == "Jacksonville" ~ "Jacksonville city",
      city == "Louisville" ~ "Louisville-Jefferson County",
      city == "St. Louis" ~ "St Louis",
      city == "Nashville" ~ "Nashville-Davidson",
      TRUE ~ city),
    county = case_when(
      county == "St. Louis City" ~ "St. Louis city", 
       county == "St. Louis County" ~ "St. Louis", 
      county == "Richmond City" ~ "Richmond city", 
      TRUE ~ county))

cities %<>%
  inner_join(FIPS_info_subset, by = c("State" = "state", "City" = "city")) %>%
  transmute(
    FIPS, 
    city_county_status = "city",
    allocation = Allocation) 

counties %<>%
  mutate(
    County = str_remove_all(County, " County")) %>%
  inner_join(FIPS_info_subset, by = c("State" = "state", "County" = "county")) %>%
  transmute(
    FIPS,
    city_county_status = "county",
    allocation = Allocation)

output <- bind_rows(cities, counties)

output %<>%
  mutate(allocation = str_remove(allocation, "\\$") %>% 
           str_remove_all(",") %>%
           as.numeric()) %>%
  left_join(pop_df)

output %<>%
  filter(FIPS %not_in% c("12031", "29189", "37183", "39113", "51760")) %>%
  mutate(
    county_allocation_scaled = county_allocation / county_population * city_population,
    allocation1 = city_allocation + county_allocation,
    allocation2 = city_allocation + county_allocation_scaled,
    
    city_allocation_pp = city_allocation / city_population,
    county_allocation_pp = county_allocation / county_population,
    county_allocation_scaled_pp = county_allocation_scaled / county_population,
    
    allocation_pp = city_allocation_pp + county_allocation_pp,
    
    city_pct = city_population / county_population * 100)

output_cities <- output %>% 
  select(FIPS,
         allocation = city_allocation,
         population = city_population)

output_counties <- output %>% 
  select(FIPS,
         allocation = county_allocation,
         population = county_population)

governments_cities <- governments %>%
  filter(city_county_status == "city")

governments_counties <- governments %>%
  filter(city_county_status == "county")


```


