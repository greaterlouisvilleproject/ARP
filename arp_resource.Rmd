---
title: "arp_resource"
output: html_document
date: "2022-11-17"
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, 
                      dev.args=list(bg="transparent"), fig.width=16,fig.height=12)
library(glptools)
glp_load_packages(TRUE)
library(arrow)
library(viridis)
library(forcats)
library(hrbrthemes)
library(glpdata)
```


```{r peer_citie}
FIPS_df <- glptools::FIPS_df

FIPS_info <- glptools::FIPS_info
```


```{r governments}
# Create clean governments data frame
projects <- read_csv("ARP Project Reports - Projects.csv",
                      col_types = "cccccccccccncnncnnccc")

# Select only government ID columns, keep only distinct rows, and replace the Birmingham FIPS code 1073 with 01073
governments <- projects %>%
  select(FIPS, 
         State, 
         city_county = `city/county`, 
         city_county_status = `city/county_status`) %>%
  distinct() %>%
  pull_peers()

# Should have 17 cities and 17 - 3 = 14 counties 


## Read in city and county allocations
cities <- read_csv("fiscalrecoveryfunds-metrocitiesfunding1-CSV.csv")
counties <- read_csv("fiscalrecoveryfunds_countyfunding_2021.05.10-1a.csv")

# Create a FIPS data frame with 
FIPS_info_subset <- FIPS_info %>%
  filter(
    county != "St. Louis County", 
    FIPS != "MERGED", 
    current == 1)

# Read in city population data
city_pop <- read_csv("city_pop.csv") %>% 
  left_join(FIPS_info_subset) %>%
  select(FIPS, city_population = population)

# Read in county population and combine with city population
pop_df <- glpdata::population_county %>%
  filter(year == max(year),
         sex == "total",
         race == "total") %>%
  select(FIPS, county_population = population) %>%
  left_join(city_pop)

FIPS_info_subset <- FIPS_info %>%
  mutate(
    city = case_when(
      city == "Jacksonville" ~ "Jacksonville city",
      city == "Louisville" ~ "Louisville-Jefferson County",
      city == "St. Louis" ~ "St Louis",
      city == "Nashville" ~ "Nashville-Davidson",
      TRUE ~ city),
    county = case_when(
      county == "St. Louis City" ~ "St. Louis city", 
       county == "St. Louis County" ~ "St. Louis", 
      county == "Richmond City" ~ "Richmond city", 
      TRUE ~ county))

cities %<>%
  inner_join(FIPS_info_subset, by = c("State" = "state", "City" = "city")) %>%
  transmute(
    FIPS, 
    city_county_status = "city",
    allocation = Allocation) 

counties %<>%
  mutate(
    County = str_remove_all(County, " County")) %>%
  inner_join(FIPS_info_subset, by = c("State" = "state", "County" = "county")) %>%
  transmute(
    FIPS,
    city_county_status = "county",
    allocation = Allocation)

output <- bind_rows(cities, counties)

output %<>%
  mutate(allocation = str_remove(allocation, "\\$") %>% 
           str_remove_all(",") %>%
           as.numeric()) %>%
  left_join(pop_df)

output %<>%
  filter(FIPS %not_in% c("12031", "29189", "37183", "39113", "51760")) %>%
  mutate(
    county_allocation_scaled = county_allocation / county_population * city_population,
    allocation1 = city_allocation + county_allocation,
    allocation2 = city_allocation + county_allocation_scaled,
    
    city_allocation_pp = city_allocation / city_population,
    county_allocation_pp = county_allocation / county_population,
    county_allocation_scaled_pp = county_allocation_scaled / county_population,
    
    allocation_pp = city_allocation_pp + county_allocation_pp,
    
    city_pct = city_population / county_population * 100)

output_cities <- output %>% 
  select(FIPS,
         allocation = city_allocation,
         population = city_population)

output_counties <- output %>% 
  select(FIPS,
         allocation = county_allocation,
         population = county_population)

governments_cities <- governments %>%
  filter(city_county_status == "city")

governments_counties <- governments %>%
  filter(city_county_status == "county")


```


```{r projects}



```

```{r louisville expenditures}


expenditures <- read_csv("ARP Project Reports - Expenditures.csv",
                        col_types = "cccnnnnn")

```

```{r peer expenditure cleanup}

#create crosswalk file
expenditures_peer_crosswalk <- read_csv("ARP Project Reports - project_to_govenment_crosswalk.csv") %>%
  mutate(
    `Recipient Name`= `Recipeint Name`
  )


#read in quarterly expenditures
q4_2021_peer_exp <- read_csv("SLFRF-January-2022-Quarterly-Data-through-December-31-2021.xlsx - Project Updated.csv")
q1_2022_peer_exp <- read.csv("April-2022-Quarterly-and-Annual-Reporting-Data-through-March-31-2022 (5).xlsx - Projects.csv")
q2_2022_peer_exp <-read.csv("July-2022-Quarterly-Reporting-Data-through-June-30-2022 (5).xlsx - Projects.csv")


####### recode column names

#q2 2022
q2_2022_peer_exp_filter <- q2_2022_peer_exp %>% 
  select('Recipient.Name', 'State.Territory', 'Completion.Status', "Project.Name", "Expenditure.Category.Group",
         "Expenditure.Category", "Project.Description", "Adopted.Budget", "Total.Cumulative.Obligations", "Total.Cumulative.Expenditures"
) %>% 
  mutate_at(c("Adopted.Budget", 
              "Total.Cumulative.Obligations", 
              "Total.Cumulative.Expenditures"), as.numeric) %>%
  mutate(year = '2022',
         quarter = 'Q2')

#q1 2022
#does not contain 'Completion.Status'
q1_2022_peer_exp_filter <- q1_2022_peer_exp %>%
  select('Recipient.Name', 'State.Territory', "Project.Name", "Expenditure.Category.Group", "Expenditure.Category", "Project.Description", "Adopted.Budget", "Total.Cumulative.Obligations", "Total.Cumulative.Expenditures"
  ) %>%
  mutate_at(c("Adopted.Budget", 
              "Total.Cumulative.Obligations", 
              "Total.Cumulative.Expenditures"), as.numeric) %>%
    mutate(year = '2022',
         quarter = 'Q1')

#q4 2021
#does not have completion status
q4_2021_peer_exp_filter <- q4_2021_peer_exp %>%
  select("Recipient Name", "State/Territory", "Project Name", "Expenditure Category Group", 
         "Expenditure Category", "Project Description", "Adopted Budget", "Total Obligations", "Total Expenditures"
  ) %>%
  mutate(
    Recipient.Name = `Recipient Name`,
    State.Territory = `State/Territory`,
    Project.Name = `Project Name`,
    Expenditure.Category.Group = `Expenditure Category Group`,
    Expenditure.Category = `Expenditure Category`,
    Project.Description = `Project Description`,
    Adopted.Budget = `Adopted Budget`,
    Total.Cumulative.Obligations = `Total Obligations`,
    Total.Cumulative.Expenditures = `Total Expenditures`
    ) %>%
  select("Recipient.Name", "State.Territory", "Project.Name", "Expenditure.Category.Group", 
         "Expenditure.Category", "Project.Description", "Adopted.Budget", "Total.Cumulative.Obligations", "Total.Cumulative.Expenditures") %>%
    mutate(year = '2021',
         quarter = 'Q4')

#bind rows
expenditures_peer_temp <- bind_rows(q2_2022_peer_exp_filter, 
                                    q1_2022_peer_exp_filter, 
                                    q4_2021_peer_exp_filter)


#create new column in expenditures_peer_temp with state abbreviation
expenditures_peer_temp$state_abbr <- state.abb[match(expenditures_peer_temp$State.Territory, state.name)]


#merge expenditures_peer_temp with cross walk
expenditures_peer_temp <- expenditures_peer_temp %>%
  mutate(
    `Recipient Name`= Recipient.Name
  )

expenditures_crosswalk_merge <- expenditures_peer_crosswalk %>%
  left_join(expenditures_peer_temp, by = c("Recipient Name", "state_abbr"))

#merge expenditures_crosswalk_merge with government dataframe
expenditure_peer <- governments %>%
  left_join(expenditures_crosswalk_merge, by = c("city_county", "city_county_status")) %>% 
  mutate(State = State.x) %>%
  select(-c("Recipeint Name", "State.y", "state_abbr", "Recipient Name", "State.Territory", "State.x")) %>%
  relocate(State, .before = city_county)
  

  

```

